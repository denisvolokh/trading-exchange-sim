<!doctype html>
<html>
    <head>
        <title>Exchange Order Book</title>
        <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.6/dist/htmx.min.js"></script>
        <link
            href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
            rel="stylesheet"
        />
        <style>
            @keyframes flash {
                from {
                    background-color: #fefcbf;
                } /* Tailwind yellow-100 */
                to {
                    background-color: transparent;
                }
            }

            .flash {
                animation: flash 1s ease-out;
            }
        </style>
    </head>
    <body class="bg-gray-50 min-h-screen p-4">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
            ðŸ“Š Exchange Emulator
        </h1>

        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Order Form -->
            <div class="bg-white rounded-lg shadow p-4">
                <div hx-get="/ui/form" hx-trigger="load" hx-swap="outerHTML">
                    Loading form...
                </div>
            </div>

            <!-- Order Book -->
            <div class="bg-white rounded-lg shadow p-4">
                <h2
                    class="text-xl font-semibold mb-2 text-center text-blue-800"
                >
                    Order Book
                </h2>
                <div
                    id="orderbook"
                    class="sse-reactive max-w-3xl mx-auto bg-white shadow-md rounded-lg p-6 border border-gray-200"
                >
                    <h2
                        class="text-2xl font-bold text-center mb-4 text-gray-700"
                    >
                        ðŸ“ˆ Live Order Book
                    </h2>

                    <div class="grid grid-cols-2 gap-6">
                        <!-- Buy Orders -->
                        <div>
                            <h3
                                class="text-xl font-semibold text-green-600 border-b border-green-300 pb-1 mb-2"
                            >
                                Buy Orders
                            </h3>
                            <div
                                id="buy-orders"
                                hx-get="/ui/orderbook/bids"
                                hx-trigger="load, sse:update"
                                hx-swap="innerHTML"
                                hx-vals="js:{ ts: Date.now() }"
                            >
                                Loading...
                            </div>
                        </div>

                        <!-- Sell Orders -->
                        <div>
                            <h3
                                class="text-xl font-semibold text-red-600 border-b border-red-300 pb-1 mb-2"
                            >
                                Sell Orders
                            </h3>
                            <div
                                id="sell-orders"
                                hx-get="/ui/orderbook/asks"
                                hx-trigger="load, sse:update"
                                hx-swap="innerHTML"
                                hx-vals="js:{ ts: Date.now() }"
                            >
                                Loading...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trades -->
            <div class="bg-white rounded-lg shadow p-4">
                <h2
                    class="text-xl font-semibold mb-2 text-center text-green-800"
                >
                    Recent Trades
                </h2>
                <div
                    id="trades"
                    hx-get="/ui/trades"
                    hx-trigger="load, sse:trade"
                    hx-swap="outerHTML"
                    hx-vals="js:{ ts: Date.now() }"
                >
                    Loading trades...
                </div>
            </div>
        </div>

        <script>
            const evtSource = new EventSource("/sse");

            evtSource.onmessage = (event) => {
                const payload = JSON.parse(event.data);

                if (payload.type === "order") {
                    htmx.trigger("#buy-orders", "sse:update");
                    htmx.trigger("#sell-orders", "sse:update");
                    // htmx.trigger(".orderbook-section", "sse:update");
                }

                if (payload.type === "trade") {
                    // Trigger trade update immediately
                    htmx.trigger("#trades", "sse:trade");

                    htmx.trigger("#buy-orders", "sse:update");
                    htmx.trigger("#sell-orders", "sse:update");
                }
            };

            htmx.on("htmx:afterSwap", (e) => {
                if (
                    e.target.id === "buy-orders" ||
                    e.target.id === "sell-orders"
                ) {
                    const entries = e.target.querySelectorAll(".order-entry");

                    entries.forEach((el) => {
                        el.classList.remove("flash"); // reset if already flashing
                        void el.offsetWidth; // force reflow to restart animation
                        el.classList.add("flash"); // apply the highlight
                    });
                }
            });
        </script>
    </body>
</html>
